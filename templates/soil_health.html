{% extends "home.html" %}
{% block title %}Soil Health Â· PrecisionGrow{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="text-center mb-3">
  <h2 class="text-success fw-bold">Soil Health Analysis ðŸŒ±</h2>
  <p class="lead-muted">Live sensor feed and recommendations</p>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card project-card p-3">
      <h5>Live Sensor Feed Graphs</h5>
      <canvas id="liveFeedChart" style="height:360px;"></canvas>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card project-card p-3 mb-3">
      <h6>Current Sensor Data</h6>
      <div id="liveMetrics" class="list-group list-group-flush small">
        <div class="list-group-item">Loading sensor data...</div>
      </div>
    </div>

    <div class="card project-card p-3">
      <h6>Recommendations</h6>
      <div id="liveRecs" class="list-group list-group-flush small">
        <div class="list-group-item">Fetching recommendations...</div>
      </div>
      <div class="d-grid mt-3">
        <a href="{{ url_for('download_soil_report') }}" class="btn btn-success">ðŸ“„ Download Soil Health Report</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ctx = document.getElementById('liveFeedChart').getContext('2d');
let liveChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'pH', data: [], borderColor: '#2e7d32', fill: false, tension: 0.3 },
            { label: 'Temperature (Â°C)', data: [], borderColor: '#f39c12', fill: false, tension: 0.3 },
            { label: 'Humidity (%)', data: [], borderColor: '#0288d1', fill: false, tension: 0.3 },
            { label: 'N (ppm)', data: [], borderColor: '#8e44ad', fill: false, tension: 0.3 }
        ]
    },
    options: {
        responsive: true,
        scales: { x: { title: { display: true, text: 'Time' } }, y: { beginAtZero: true } }
    }
});

async function fetchLive() {
  try {
    const res = await fetch('/soil-health-live');
    const json = await res.json();
    const metricsEl = document.getElementById('liveMetrics');
    const recsEl = document.getElementById('liveRecs');
    metricsEl.innerHTML = '';
    recsEl.innerHTML = '';

    if (json.error) {
      metricsEl.innerHTML = `<div class="list-group-item text-danger">${json.error}</div>`;
      recsEl.innerHTML = `<div class="list-group-item">No recommendations available.</div>`;
      return;
    }

    const data = json.data || {};
    const recs = json.recommendations || {};

    // Metrics
    for (const [k,v] of Object.entries(data)) {
      metricsEl.innerHTML += `<div class="list-group-item d-flex justify-content-between"><div><strong>${k}</strong></div><div><span class="badge bg-light text-dark">${v}</span></div></div>`;
    }

    // Recs
    if (Object.keys(recs).length === 0) {
      recsEl.innerHTML = `<div class="list-group-item">Soil appears healthy.</div>`;
    } else {
      for (const r of Object.values(recs)) recsEl.innerHTML += `<div class="list-group-item">${r}</div>`;
    }

    // Update Chart
    const ts = new Date().toLocaleTimeString();
    liveChart.data.labels.push(ts);
    liveChart.data.datasets[0].data.push(data.ph ?? 0);
    liveChart.data.datasets[1].data.push(data.temperature ?? 0);
    liveChart.data.datasets[2].data.push(data.humidity ?? 0);
    liveChart.data.datasets[3].data.push(data.N ?? 0);

    if (liveChart.data.labels.length > 12) {
      liveChart.data.labels.shift();
      liveChart.data.datasets.forEach(ds => ds.data.shift());
    }
    liveChart.update();

  } catch (err) {
    console.error(err);
  }
}

// initial + periodic
fetchLive();
setInterval(fetchLive, 15000);
</script>
{% endblock %}
